const { useState, useEffect, useRef } = React;

        // --- æ¨¡æ‹Ÿç®€å•çš„å…«å­—ç®—æ³• (æ ¹æ®ç”Ÿæ—¥å®šäº”è¡Œ) ---
        // çœŸæ­£çš„ç®—æ³•éœ€è¦ huge libraryï¼Œè¿™é‡Œç”¨æ•°å­¦é€»è¾‘æ¨¡æ‹Ÿâ€œä¼ªçœŸå®æ„Ÿâ€
        const ELEMENT_CONFIG = {
            0: { type: 'Metal', color: 'bg-morandi-mist', hex: '#E0E5DF', vibe: 'ç§©åº', advice: 'ä»Šæ—¥ä¸–ç•Œçº·æ‰°ï¼Œä½†ä½ å†…å¿ƒå¦‚é‡‘å±èˆ¬æœ‰åºã€‚é€‚åˆåšå‡æ³•ï¼Œæ¸…ç†æ‚å¿µã€‚' },
            1: { type: 'Water', color: 'bg-morandi-haze', hex: '#B0C4DE', vibe: 'æµåŠ¨', advice: 'ä¸Šå–„è‹¥æ°´ã€‚ä»Šæ—¥é€‚åˆåœ¨å˜åŒ–ä¸­å¯»æ‰¾æœºä¼šï¼Œä¸è¦å¯¹æŠ—ï¼Œè¦åŒ…å®¹ã€‚' },
            2: { type: 'Wood', color: 'bg-morandi-sage', hex: '#BCE2D1', vibe: 'ç”Ÿé•¿', advice: 'ç”Ÿæœºå‹ƒå‹ƒçš„ä¸€å¤©ã€‚åƒæ ‘æœ¨ä¸€æ ·æ‰æ ¹å½“ä¸‹ï¼Œå‘ä¸Šä¼¸å±•ä½ çš„æƒ³æ³•ã€‚' },
            3: { type: 'Fire', color: 'bg-morandi-dusty', hex: '#D8BFD8', vibe: 'çƒ­æƒ…', advice: 'ä½ å°±æ˜¯å¾®å…‰ã€‚ä»Šæ—¥ä½ çš„ç›´è§‰æå‡†ï¼Œè·Ÿéšå†…å¿ƒçš„ç«èŠ±è¡ŒåŠ¨å§ã€‚' },
            4: { type: 'Earth', color: 'bg-morandi-oat', hex: '#F5DEB3', vibe: 'æ‰¿æ‰˜', advice: 'å¤§åœ°èˆ¬ç¨³é‡ã€‚åˆ«æ€¥ç€å†²åˆºï¼Œä»Šå¤©é€‚åˆå¤ç›˜å’Œç§¯ç´¯ã€‚' }
        };

        function calculateDestiny(dateStr) {
            // æ ¹æ®å‡ºç”Ÿæ—¥æœŸ + ä»Šæ—¥æ—¥æœŸ = ç”Ÿæˆå”¯ä¸€ç»“æœ
            const birth = new Date(dateStr);
            const today = new Date();
            
            // ç®€å•ç®—æ³•ï¼š(å‡ºç”Ÿå¹´+æœˆ+æ—¥ + ä»Šæ—¥æ—¥) % 5
            const seed = birth.getFullYear() + birth.getMonth() + birth.getDate() + today.getDate();
            const index = seed % 5;
            
            return {
                ...ELEMENT_CONFIG[index],
                luckyNumber: (seed % 9) + 1,
            };
        }

        // --- ç»„ä»¶å¤ç”¨éƒ¨åˆ† (LuckyBackground, NariAvatar ä¿æŒä¸å˜) ---
        const LuckyBackground = ({ themeHex = '#E0E5DF', children }) => {
            return (
                <div className="relative w-full h-screen overflow-hidden bg-morandi-shell transition-colors duration-1000">
                    <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] rounded-full mix-blend-multiply filter blur-[80px] opacity-70 animate-blob" style={{ backgroundColor: themeHex }}></div>
                    <div className="absolute top-[20%] right-[-10%] w-[400px] h-[400px] rounded-full bg-morandi-oat mix-blend-multiply filter blur-[80px] opacity-60 animate-blob" style={{ animationDelay: '2s' }}></div>
                    <div className="relative z-10 w-full h-full flex flex-col">{children}</div>
                </div>
            );
        };

        const NariAvatar = ({ state = 'meditating', size = 'md', onClick }) => {
            const sizeClass = size === 'lg' ? 'w-48 h-48' : (size === 'sm' ? 'w-16 h-16' : 'w-32 h-32');
            return (
                <div className={`${sizeClass} relative cursor-pointer`} onClick={onClick}>
                    <div className="w-full h-full animate-float relative flex items-center justify-center">
                        <div className="w-[80%] h-[80%] bg-nari-black rounded-[2rem] shadow-xl relative overflow-hidden border-2 border-nari-silver/20 z-10">
                            <div className="absolute top-[25%] left-0 w-full flex justify-center gap-3 px-2">
                                <div className="w-[35%] h-3 bg-nari-silver rounded-full rotate-12"></div>
                                <div className="w-[35%] h-3 bg-nari-silver rounded-full -rotate-12"></div>
                            </div>
                            <div className="absolute top-[48%] left-0 w-full flex justify-center gap-6">
                                {state === 'meditating' ? (
                                    <><div className="w-4 h-1 bg-gray-600 rounded-full"></div><div className="w-4 h-1 bg-gray-600 rounded-full"></div></>
                                ) : (
                                    <><div className="w-3 h-3 bg-white rounded-full animate-pulse"></div><div className="w-3 h-3 bg-white rounded-full animate-pulse"></div></>
                                )}
                            </div>
                            <div className="absolute bottom-[-10%] left-[10%] w-[80%] h-[45%] bg-nari-silver rounded-t-[30px]"></div>
                        </div>
                        {state === 'meditating' && <div className="absolute inset-0 border-2 border-white/40 rounded-full animate-breathe opacity-50"></div>}
                        {state === 'happy' && <div className="absolute top-0 right-0 text-3xl animate-bounce">âœ¨</div>}
                    </div>
                </div>
            );
        };

        // --- æ–°å¢ï¼šç”Ÿæ—¥è¾“å…¥é¡µ (Onboarding View) ---
        const OnboardingView = ({ onComplete }) => {
            const [date, setDate] = useState('');

            const handleSubmit = () => {
                if (!date) return alert("è¯·å‘Šè¯‰ Nari ä½ çš„ç ´å£³æ—¥ ğŸ‚");
                onComplete(date);
            };

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-in fade-in zoom-in duration-500">
                    <div className="mb-8"><NariAvatar state="happy" size="md" /></div>
                    <h2 className="text-2xl font-serif text-gray-700 mb-2">å½“ä½ æ¥åˆ°è¿™ä¸ªæ˜Ÿçƒ...</h2>
                    <p className="text-xs text-gray-500 mb-8">Nari éœ€è¦è¿™ä¸ªæ—¶é—´åæ ‡æ¥è¿æ¥å®‡å®™èƒ½é‡</p>
                    
                    <input 
                        type="date" 
                        onChange={(e) => setDate(e.target.value)}
                        className="w-full max-w-xs p-4 rounded-xl bg-white/50 text-center text-gray-700 font-serif text-lg mb-8 focus:outline-none focus:ring-2 focus:ring-morandi-haze"
                    />
                    
                    <button onClick={handleSubmit} className="w-full max-w-xs py-4 rounded-xl bg-nari-black text-white font-serif tracking-widest shadow-lg">
                        å¼€å§‹æµ‹ç®—
                    </button>
                </div>
            );
        };

        const HomeView = ({ onStart }) => {
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 text-center gap-8 animate-in fade-in">
                    <div>
                        <h1 className="text-5xl font-serif text-nari-black tracking-widest mb-2">Lucky Day</h1>
                        <p className="text-xs text-gray-500 uppercase tracking-[0.4em]">Web3 Spiritual Sanctuary</p>
                    </div>
                    <NariAvatar state="meditating" size="lg" />
                    <button onClick={onStart} className="relative group mt-8">
                        <div className="absolute inset-0 bg-gradient-to-r from-morandi-sage to-morandi-haze rounded-full blur opacity-40 group-hover:opacity-60 transition-opacity"></div>
                        <div className="relative px-10 py-4 bg-white/40 backdrop-blur-md border border-white/60 rounded-full text-gray-700 font-serif tracking-widest hover:scale-105 transition-transform">
                            Connect & Breathe
                        </div>
                    </button>
                    <p className="absolute bottom-10 text-[10px] text-gray-400">Powered by Nari & Ethereum</p>
                </div>
            );
        };

        const DailyView = ({ fortune, setView }) => {
            return (
                <div className="flex-1 flex flex-col items-center pt-10 pb-10 px-6 overflow-y-auto animate-in slide-in-from-bottom duration-700">
                    <div className="w-full flex justify-between items-center max-w-md mb-6">
                        <button onClick={() => setView('home')} className="text-sm text-gray-500 font-serif">â† Exit</button>
                        <button onClick={() => setView('resonance')} className="px-3 py-1 bg-white/40 rounded-full text-xs text-gray-600 font-serif">Energy Sync âœ¨</button>
                    </div>
                    <div className="mb-[-20px] z-20"><NariAvatar state="happy" size="md" /></div>
                    <div className="w-full max-w-md bg-white/40 backdrop-blur-xl border border-white/60 rounded-[32px] p-8 shadow-2xl flex flex-col items-center text-center z-10">
                        <div className="text-xs text-gray-400 mb-4 tracking-widest uppercase">{new Date().toDateString()}</div>
                        <h2 className="text-4xl font-serif text-nari-black mb-6 animate-pulse">{fortune.vibe}</h2>
                        <p className="text-gray-600 leading-relaxed font-serif text-sm mb-8 opacity-90">â€œ{fortune.advice}â€</p>
                        <div className="grid grid-cols-2 gap-4 w-full mb-6">
                            <div className="p-4 bg-white/50 rounded-2xl flex flex-col items-center">
                                <span className="text-[10px] text-gray-400 uppercase mb-1">Color</span>
                                <div className={`w-8 h-8 rounded-full ${fortune.color} border border-white/50 shadow-sm mb-1`}></div>
                                <span className="text-xs text-gray-500">è«å…°è¿ªè‰²</span>
                            </div>
                            <div className="p-4 bg-white/50 rounded-2xl flex flex-col items-center justify-center">
                                <span className="text-[10px] text-gray-400 uppercase mb-1">Number</span>
                                <span className="text-2xl font-serif text-gray-700">{fortune.luckyNumber}</span>
                            </div>
                        </div>
                        <button className="w-full py-3 rounded-xl bg-nari-black text-nari-silver font-sans text-sm tracking-wide shadow-lg">Share My Lucky Day</button>
                    </div>
                </div>
            );
        };

        const ResonanceView = ({ setView }) => {
            const [step, setStep] = useState(0); 
            return (
                <div className="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center animate-in fade-in">
                    <button onClick={() => setView('daily')} className="absolute top-8 right-8 text-2xl text-gray-400">Ã—</button>
                    <div className="relative w-full h-[50vh] flex items-center justify-center">
                        <div className={`absolute w-40 h-40 rounded-full blur-2xl opacity-80 bg-morandi-haze transition-all duration-[2000ms] ${step >= 1 ? 'translate-x-0 scale-125' : '-translate-x-24'}`}></div>
                        <div className={`absolute w-40 h-40 rounded-full blur-2xl opacity-80 bg-morandi-oat transition-all duration-[2000ms] ${step >= 1 ? 'translate-x-0 scale-125' : 'translate-x-24'}`}></div>
                        {step === 2 && (
                            <div className="z-20 text-center animate-in zoom-in fade-in duration-700 flex flex-col items-center">
                                <div className="flex gap-[-10px] mb-4"><NariAvatar state="happy" size="sm" /><div className="-ml-4 transform scale-x-[-1]"><NariAvatar state="happy" size="sm" /></div></div>
                                <h2 className="text-3xl font-serif text-gray-700 mb-2">Soul Sync</h2>
                                <p className="text-gray-500 font-light text-sm max-w-xs mx-auto px-6">"åƒå¾®é£é‡åˆ°äº†äº‘æœµï¼Œ<br/>ä½ ä»¬çš„èƒ½é‡åœ¨ä»Šæ—¥è¾¾åˆ°äº†å®Œç¾çš„å¹³è¡¡ã€‚"</p>
                            </div>
                        )}
                    </div>
                    <div className="absolute bottom-16 w-full px-8">
                        {step === 0 ? (
                            <div className="flex flex-col gap-4 animate-in slide-in-from-bottom">
                                <input type="text" placeholder="å¥½å‹åå­— / Web3 ID" className="w-full p-4 rounded-xl bg-gray-100 text-center font-serif focus:outline-none focus:ring-1 focus:ring-morandi-haze" />
                                <button onClick={() => { setStep(1); setTimeout(() => setStep(2), 2500); }} className="w-full py-4 rounded-xl bg-nari-black text-white font-serif tracking-widest shadow-lg">Start Resonance</button>
                            </div>
                        ) : step === 2 ? (
                            <button onClick={() => setStep(0)} className="w-full py-4 rounded-xl border border-gray-300 text-gray-500 font-serif">Try Another Friend</button>
                        ) : null}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home'); // home -> onboarding -> daily -> resonance
            const [fortune, setFortune] = useState(null);

            // æµç¨‹æ§åˆ¶å™¨
            const startFlow = () => setView('onboarding'); // 1. å»è¾“å…¥ç”Ÿæ—¥
            
            const handleBirthdaySubmit = (dateStr) => {
                // 2. æ ¹æ®ç”Ÿæ—¥è®¡ç®—ç»“æœ
                const data = calculateDestiny(dateStr);
                setFortune(data);
                setView('daily'); // 3. çœ‹ç»“æœ
            };

            return (
                <LuckyBackground themeHex={fortune ? fortune.hex : '#E0E5DF'}>
                    {view === 'home' && <HomeView onStart={startFlow} />}
                    {view === 'onboarding' && <OnboardingView onComplete={handleBirthdaySubmit} />}
                    {view === 'daily' && <DailyView fortune={fortune} setView={setView} />}
                    {view === 'resonance' && <ResonanceView setView={setView} />}
                </LuckyBackground>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
